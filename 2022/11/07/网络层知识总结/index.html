<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>Computer Network - 网络层概述 | HenryD Blog</title><meta name="author" content="Henry.D"><meta name="copyright" content="Henry.D"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="网络层的内容相对比较多，总结出一些重要的部分，作为回顾和自测的材料"><link rel="shortcut icon" href="/img/webpic.png"><link rel="canonical" href="http://example.com/2022/11/07/%E7%BD%91%E7%BB%9C%E5%B1%82%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: undefined,
  noticeOutdate: {"limitDay":999,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Computer Network - 网络层概述',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-11-08 18:15:33'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = url => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      link.onload = () => resolve()
      link.onerror = () => reject()
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/font.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/./img/touxiang.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">40</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">47</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">11</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="HenryD Blog"><span class="site-name">HenryD Blog</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">Computer Network - 网络层概述</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2022-11-07T13:20:00.000Z" title="Created 2022-11-07 21:20:00">2022-11-07</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2022-11-08T10:15:33.442Z" title="Updated 2022-11-08 18:15:33">2022-11-08</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Network/">Network</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Computer Network - 网络层概述"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><article class="post-content" id="article-container"><h2 id="1-网络层概述">1. 网络层概述</h2>
<h3 id="1-1-网络层的工作内容">1.1 网络层的工作内容</h3>
<p>这是根据网络层在网络体系结构中的地位确定的，网络层下层是数据链路层，上层是运输层。</p>
<p>从数据链路层干的活来看，数据链路层主要解决三个基本问题：</p>
<ul>
<li>
<p>封装成帧</p>
</li>
<li>
<p>透明传输</p>
</li>
<li>
<p>差错检测</p>
</li>
</ul>
<p>也就是说到了数据链路层后，我们已经可以解决“数据在链路上怎样传输”。而网络层要干的事情主要是将分组从源主机经过多个网络和多段链路传输到目的主机，可以将该任务划分为<strong>分组转发和路由选择</strong>两种重要的功能。有了网络层，才能够真正实现大范围的互联网，才能够将世界真正的连接起来。</p>
<h3 id="1-2-网络层给运输层提供的服务">1.2 网络层给运输层提供的服务</h3>
<p>网络层应该为运输层提供怎样的服务？背后本质的问题是可靠交付是应该由网络系统还是端系统保证，这实际上是一个设计的问题，相对可行的方案有两种：</p>
<ul>
<li>
<p>面向连接的虚电路服务（并未被因特网采用）</p>
</li>
<li>
<p>无连接的数据报服务（因特网采用，我们学习的重点）</p>
<ul>
<li>
<p>核心思想：可靠通信应该由用户的主机保证</p>
</li>
<li>
<p>不需要建立网络层连接</p>
</li>
<li>
<p>每个分组可以走不同的路径，这也使得每个分组首部必须携带目的主机的完整地址</p>
</li>
<li>
<p>通信结束后不需要释放连接</p>
</li>
</ul>
</li>
</ul>
<p>互联网最终决定的设计思想是：网络层向上只提供简单灵活的、无连接的、尽最大努力交付的数据报服务，也就是网络层并不提供服务质量的承诺。这种设计思想使得网络中路由器的设计更简单，降低整个网络的建造成本，为因特网的广泛应用打下基础。</p>
<h2 id="2-网际协议">2.网际协议</h2>
<h3 id="2-1-网络协议IP的由来">2.1 网络协议IP的由来</h3>
<p>问题：因特网由不同的异构网络互联而成，而将众多的异构网络互联起来并不容易，要面对：</p>
<ul>
<li>
<p>不同的网络接入机制</p>
</li>
<li>
<p>不同的差错恢复方法</p>
</li>
<li>
<p>不同的路由选择技术</p>
</li>
<li>
<p>不同的寻址方案</p>
</li>
<li>
<p>不同的最大分组长度</p>
</li>
<li>
<p>不同的服务（面向连接服务和无连接服务）</p>
</li>
</ul>
<p>于是引出IP网的概念，使用一种协议，让主机与主机之间的通信看不到异构网络之间的细节，就好像在一个单一的网络上通信一样。这个协议就是网际协议IP，是TCP/IP体系结构中的核心协议。</p>
<p>那么为什么不能让所有的人都使用同一种结构的网络？</p>
<ul>
<li>因为这是不切实际的，不同的网络结构由不同的使用场合，全世界统一是天方夜谭</li>
</ul>
<p>那么想组成现实生活中的巨大的因特网，需要哪些设备？</p>
<ul>
<li>
<p>转发器（物理层）</p>
</li>
<li>
<p>网桥、交换机（数据链路层）</p>
</li>
<li>
<p>路由器（网络层）</p>
</li>
<li>
<p>网关（网络层之上使用）</p>
</li>
</ul>
<p>其中路由器往上才是把不同网络连接在一起，转发器和网桥仅仅是扩大网络。路由器和网关由于历史的原因，有时候也混称为一个东西。</p>
<h3 id="2-2-IPV4地址">2.2 IPV4地址</h3>
<p>问题：异构网络用路由器设备连接起来了，那么数据从A到B是怎么发送的？怎么找到目的地的，又怎么知道该发给谁的，很容易联想到的就是起名字，尤其是会想到用链路层的知识：MAC地址标识主机，那么用MAC地址行不行？这一连串的问题，也是IP网际协议可以解决的。</p>
<p>IPV4地址：</p>
<ul>
<li>
<p>给因特网上的每一个主机（或者路由器）的每一个接口分配的一个在全世界范围内的唯一的32位bit的标识</p>
</li>
<li>
<p>IPV4地址由因特网名字和数字分配机构ICANN进行分配</p>
</li>
<li>
<p>IPV4编制方法演变：</p>
<ul>
<li>
<p>分类编址（已成过去）：两级结构，分为网络号、主机号</p>
</li>
<li>
<p>划分子网（已成过去）：三级结构，网络号、子网号、主机号，使用的是子网掩码</p>
</li>
<li>
<p>无分类编址CIDR（现今主流）：两级结构，网络前缀、主机号，使用地址掩码</p>
</li>
</ul>
</li>
</ul>
<p>CIDR：</p>
<ul>
<li>
<p>CIDR不使用子网，是指CIDR并没有在32位地址中指明若干位作为子网，但是一个单位分配到一个CIDR地址块（网络前缀都相同的连续的IP地址组成一个“CIDR地址块”）的话，仍然可以在本单位内根据需求划分出一些子网，这些子网也都只有一个网络前缀和一台主机号字段。</p>
</li>
<li>
<p>由于一个CIDR地址块中有很多地址，所以在路由表中就利用CIDR地址块来查找网络，这种地址的聚合通常称为<strong>路由聚合</strong>，这使得路由表项目数大大减少。而聚合后在使用路由表查找转发分组时发现有许多条路由条目匹配时，选择使用网络前缀匹配得最长的那条进行转发，这叫做<strong>最长前缀匹配</strong>。这是因为网络前缀越长，其地址块就越小，而路由就越具体。查找最长前缀匹配的算法一般是使用<strong>二叉线索匹配</strong>。</p>
</li>
</ul>
<p>IPV4地址和MAC地址：</p>
<ul>
<li>
<p>IP地址封装位置如图所示：</p>
<p><img src="https://cdn.jsdelivr.net/gh/hyattdd/cloud_img@master/blog/image-7901856.png" alt="image"></p>
</li>
<li>
<p>数据报传送过程中的IP源地址和目的地址不变</p>
<ul>
<li>数据报传送过程中的源MAC地址和目的MAC地址逐链路/网络改变</li>
</ul>
</li>
</ul>
<p>回答问题：为什么不用MAC地址通信，非要搞出来个IP地址？</p>
<ul>
<li>IP地址这种抽象更加方便网络体系结构的设计和管理，而且如果全部是使用MAC地址，海量的信息需要占用极大的存储、计算资源，会让整个网络的传送效率大打折扣，而且不同的主机的MAC地址不同，甚至不同网络中的硬件的MAC地址规范还可能不同，那么如果都让我们自己使用的主机去根据这些纷繁错乱的MAC地址去通信是很难得。后面学习到的ARP协议做的工作就是将IP地址和MAC的映射问题解决了，我们只需要使用我们自己抽象出来的IP来描述所有设备，就好像全世界都在一个网络中一样，很方便。</li>
</ul>
<h3 id="2-3-地址解析协议ARP">2.3 地址解析协议ARP</h3>
<p>问题：A知道了B的IP地址后想往B发送信息，但是不知道B的MAC地址，那么A在数据链路层对数据进行封装的时候，没法填写目的MAC地址。毕竟我们在实际网络的链路层上传送数据帧时最终还是需要使用硬件地址的，这怎么办？</p>
<p>于是就有了ARP协议：</p>
<ul>
<li>
<p>ARP协议在IP层使用，可以说是网络层的协议，到那时解析出的是MAC地址，也可以算链路层</p>
</li>
<li>
<p>每台主机都有一个ARP高速缓存（ARP Cache），存放的是本局域网上的各主机和路由器的IP地址到硬件地址的映射表，且是动态更新的。因为一个局域网中在线的设备是随时在变化的。</p>
</li>
<li>
<p>ARP的生存时间：考虑到各个主机在局域网中是动态上线的，给ARP缓存设置生存时间有利于及时删除不具有实效性的IP-MAC映射信息</p>
</li>
</ul>
<p>ARP协议运行过程：</p>
<ul>
<li>
<p>A想给本局域网上的某台主机发信息时：</p>
<ul>
<li>
<p>先检查ARP缓存表，如果缓存表中查出了B的IP地址，就把该项中的MAC地址写到A要发给B的MAC帧中，然后通过局域网把该MAC帧发往该硬件地址</p>
</li>
<li>
<p>如果查不到，则此时可能是B刚加入局域网或者A刚刚开机，缓存表还是空的，这个时候A就要自动运行ARP协议。1.先向本局域网上发送一个ARP请求分组，广而告之其想知道某个（就是B的）IP地址对应的MAC地址，同时这个ARP请求分组中也包含了A自己的IP与MAC映射关系，目的是为了让B以后也能更新自己的ARP缓存表以便联系自己；2.在本局域网上的所有主机运行的ARP进程会收到该ARP请求分组；3. 只有B的IP地址和该请求分组中的IP地址一致，所以只有B会响应，于是B发送一个携带自己的MAC地址的ARP响应分组，这个响应分组是单播给A的；4.主机A收到B的响应分组后，ARP高度缓存表会把B的IP和MAC映射写入表项。</p>
</li>
</ul>
</li>
<li>
<p>A想给其他网络上的某台主机发信息时：</p>
<ul>
<li>首先要明确ARP是解决同一个局域网上的主机或者路由器的IP地址和MAC地址的映射问题</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/hyattdd/cloud_img@master/blog/image%201-7902402.png" alt="image.png"></p>
<ul>
<li>A如果在当前局域网中通过ARP无法找到B，由于在A发广播请求分组时需要通过路由器转发，所以路由器的IP地址与MAC地址的映射关系A是有的，当A发现B不在局域网中时，后面就会把IP数据包给路由器R1，而R1就会从转发表中去找下一个路由器R2，同样也会使用ARP去解析出R2的IP和MAC之间的映射关系。</li>
</ul>
</li>
</ul>
<h3 id="2-4-IP数据报的传送与静态路由配置">2.4 IP数据报的传送与静态路由配置</h3>
<p>问题：ARP请求报文发送时，A设备是怎么根据IP地址就知道B设备在不在自己同一个网段下？路由表平时又是怎么转发收到的报文的？</p>
<p>直接交付与间接交付：</p>
<ul>
<li>
<p>同一局域网，借助路由器转发，是直接交付</p>
</li>
<li>
<p>跨局域网，是间接交付</p>
</li>
</ul>
<p>判断目标主机和源主机是否在同一个网段的具体方法：</p>
<p><img src="https://cdn.jsdelivr.net/gh/hyattdd/cloud_img@master/blog/image%202-7901898.png" alt="image 2"></p>
<p>默认网关：主机中都会配置一个默认网关，当需要间接交付时，就知道通过哪个路由器了，一般目的网络地址选择的是0.0.0.0</p>
<p><img src="https://cdn.jsdelivr.net/gh/hyattdd/cloud_img@master/blog/image%203-7901926.png" alt="image 3"></p>
<p>特定主机路由：区别于常规的基于目的主机所在网络的转发方式，对特定目的主机指明一个路由，常用于考虑安全问题以及网络连接错误信息排查时使用</p>
<p><img src="https://cdn.jsdelivr.net/gh/hyattdd/cloud_img@master/blog/image%204-7901949.png" alt="image 4"></p>
<p>直连路由与非直连路由：</p>
<ul>
<li>
<p>直连：路由器的各接口配置了IP地址和地址掩码后，路由器可以自行得出自己的各接口和哪些网络是直连的，路由器将这些直连路由的条目记录在自己的路由表中</p>
</li>
<li>
<p>非直连：人工配置路由器到其他非直连路由的表项，即静态路由配置，也可通过路由选择协议路由器自动获取</p>
</li>
</ul>
<p>总的来说路由转发IP数据报的逻辑如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/hyattdd/cloud_img@master/blog/image%205-7901972.png" alt="image 5"></p>
<p>上面提到的一些路由配置手段都是静态的配置手段，后面根据路由选择协议才是动态的</p>
<h3 id="2-5-IP数据报格式">2.5 IP数据报格式</h3>
<p>首先明确一个规范：在TCP/IP标准中，数据格式一般以4字节为一个单位</p>
<p>IP数据报首部的格式如下，可以根据此图进行相关作用的默写，具体答案查看参考资料2：</p>
<p><img src="https://cdn.jsdelivr.net/gh/hyattdd/cloud_img@master/blog/image%206-7902004.png" alt="image 6"></p>
<ul>
<li>
<p>版本：表示IPV4还是IPV6</p>
</li>
<li>
<p>首部长度：占4位，最大为1111表示15个单位，即15*4 = 60个字节，这也意味着首部长度都是4字节的整数倍，那么当不足4个字节时需要补齐</p>
</li>
<li>
<p>区分服务：本来用于区分不同人给不同的网络传送质量，但是一直没用过</p>
</li>
<li>
<p>总长度：占16位，表示首部和数据之和的长度，<strong>单位为字节而不是4字节了，最大65535字节</strong></p>
</li>
<li>
<p>标识：16位，为了方便分片后能够重组起来</p>
</li>
<li>
<p>标志：3位，目前只用了2位分别表示MF（More Fragment，最低位）、DF（Don‘t fragment，中间位）</p>
</li>
<li>
<p>片偏移：13位，以8个字节为偏移单位，也就是除了最后一个数据报分片，每个分片的长度一定是以8字节（64位）的整数倍</p>
</li>
<li>
<p>生存时间：8位，TTL</p>
</li>
<li>
<p>协议：表示数据报携带的数据是使用何种协议，方便目的主机的IP层知道将数据部分上交给哪个协议进行处理</p>
</li>
<li>
<p>首部校验和：16位，检验数据报的首部，不检验数据部分</p>
</li>
</ul>
<h3 id="2-6-网际控制报文协议ICMP">2.6 网际控制报文协议ICMP</h3>
<p>ICMP（Internet Control Message Protocol）Internet控制报文协议。它是TCP/IP协议簇的一个子协议，用于在IP主机、路由器之间传递控制消息。控制消息是指网络通不通、主机是否可达、路由是否可用等网络本身的消息。这些控制消息虽然并不传输用户数据，但是对于用户数据的传递起着重要的作用。ICMP使用IP的基本支持，就像它是一个更高级别的协议，但是，ICMP实际上是IP的一个组成部分，封装在IP数据报中发送。</p>
<p><strong>ICMP报文有两类：ICMP差错报告报文、ICMP询问报文</strong></p>
<p>ICMP差错报告报文又细分为：</p>
<ul>
<li>
<p>终点不可达：当主机或者路由不能交付数据报时</p>
</li>
<li>
<p>源点抑制：当主机或者路由因为拥塞而丢弃IP数据报时向源点发送源点抑制报文</p>
</li>
<li>
<p>时间超时：TTL=0了</p>
</li>
<li>
<p>参数问题：数据报首部中有字段值不正确的</p>
</li>
<li>
<p>改变路由（重定向）：路由器把改变路由报文发送给主机，让主机知道下次应该将数据报发送给另外的路由器（可以通过更好的路由）</p>
</li>
</ul>
<p>ICMP询问报文有两种：</p>
<ul>
<li>
<p>回送请求和回答（PING使用的就是这个）</p>
</li>
<li>
<p>时间戳请求和回答</p>
</li>
</ul>
<h2 id="3-内部网关协议">3. 内部网关协议</h2>
<p>网络对于数据怎样进行转发才更高效？这就需要路由选择协议来解决了</p>
<h3 id="3-1-路由选择分类">3.1 路由选择分类</h3>
<ul>
<li>
<p>静态路由选择：人工配置，适用小规模网络</p>
</li>
<li>
<p>动态路由选择：根据<strong>路由选择协议</strong>动态生成，适用于大规模网络</p>
</li>
</ul>
<h3 id="3-2-分层路由选择协议">3.2 分层路由选择协议</h3>
<p>路由选择协议的基本特点：</p>
<ul>
<li>
<p>自适应</p>
</li>
<li>
<p>分布式</p>
</li>
<li>
<p>分层次</p>
</li>
</ul>
<p>路由选择协议分类：</p>
<ul>
<li>
<p>域间路由选择：使用内部网关协议（IGP），RIP、OSPF就是一种IGP</p>
</li>
<li>
<p>域内路由选择：使用边界网关协议（EGP），BGP就是一种EGP</p>
</li>
</ul>
<h3 id="3-3-RIP-路由信息协议（Routing-Information-Protocol）">3.3 RIP 路由信息协议（Routing Information Protocol）</h3>
<p>RIP基本概念：</p>
<ul>
<li>RIP维护的是从它自身到当前所在自制域AS的其他的每一个网络的距离记录。这些距离叫做距离向量。且RIP使用跳数对这个向量值进行表示，，到直连网络的距离是1，到不可达网络的距离为16。可以看出RIP能表示的范围不大，一般适合相对较小的互联网。（但实际上比我们想象的要大，对于一个大学而言实际上也只有几个真正的路由器，所以16跳很多时候足够一个大学城范围内的网络使用）</li>
</ul>
<p>RIP选择规则：</p>
<ul>
<li>
<p>RIP判断一个转发路线的好坏是根据跳数的，即使跳数长的路上网络带宽很高也不考虑；</p>
</li>
<li>
<p>如果RIP发现到达某个网络有多条相等的路线时，会把这些路线都记下来，进行等价负载均衡，以后的转发压力会被均衡地分散在这些多条路线中</p>
</li>
</ul>
<p>RIP的三个特点：</p>
<ul>
<li>
<p>和谁交换信息：相邻路由器</p>
</li>
<li>
<p>交换什么信息：交换自己的路由表</p>
</li>
<li>
<p>何时交换信息：周期性交换</p>
</li>
</ul>
<p>RIP的工作过程：</p>
<ul>
<li>
<p>初始时，路由器到直连网络距离为1</p>
</li>
<li>
<p>工作时，定期和相邻的路由器周期性地交换并更新路由信息</p>
</li>
<li>
<p>工作到收敛时，每个路由器都知道到达本自治系统AS内各网络的最短距离和下一跳路由器</p>
</li>
</ul>
<p>RIP协议下路由表的更新规则：</p>
<ul>
<li>
<p>新路由有优势，就覆盖旧的</p>
</li>
<li>
<p>相同距离相同下一跳，也添加，为了进行负载均衡</p>
</li>
<li>
<p>发现新的网络，添加进去</p>
</li>
</ul>
<p>RIP存在的问题：</p>
<ul>
<li>坏消息传得慢（也即路由环路/RIP距离无穷计数问题）</li>
</ul>
<p>RIP相关报文传送：</p>
<ul>
<li>
<p>使用运输层的UDP进行封装，从这看属于TCP/IP体系结构的应用层</p>
</li>
<li>
<p>核心功能是路由选择，从这看属于网际层协议</p>
</li>
</ul>
<p>RIP的优缺点：</p>
<ul>
<li>
<p>优点：实现简单，对于单一路由而言开销小，好消息传得快</p>
</li>
<li>
<p>缺点：坏消息传的慢，又因为交换完整的路由表导致随着网络规模扩大而开销增大，且15跳的范围不方便在大的AS中使用</p>
</li>
</ul>
<h3 id="3-4-OSPF-开放最短路径优先-（Open-Shortest-Path-First）">3.4 OSPF 开放最短路径优先 （Open Shortest Path First）</h3>
<p>问题：RIP有缺点，怎么办？于是OSPF来了</p>
<p>OSPF基本特点：</p>
<ul>
<li>
<p>使用了Dijkstra最短路径算法（SPF），保证了不会产生环路</p>
</li>
<li>
<p>基于链路状态的，而不是像RIP是基于距离向量</p>
</li>
<li>
<p>不限制网络规模，效率高，<strong>收敛速度还快</strong></p>
</li>
<li>
<p>OPSF也可以做多路径的负载均衡</p>
</li>
</ul>
<p>OSPF和RIP的区别：</p>
<ul>
<li>
<p>OSPF向本自治系统的所有路由器发送消息，使用的是洪泛法</p>
</li>
<li>
<p>发送的信息是和本路由器相邻的所有路由器的链路状态</p>
</li>
<li>
<p>只有当链路状态发生变化时，路由器才向所有的路由器洪泛，而不是和RIP一样定期自动发</p>
</li>
<li>
<p>OSPF可以使得每个路由器获得一个全网络的拓扑结构，即建立了链路状态数据库</p>
</li>
<li>
<p><strong>OSPF不使用UDP，而是使用IP数据报（首部协议字段为89）</strong></p>
</li>
</ul>
<p>OSPF相关基本概念：</p>
<ul>
<li>
<p>链路状态Link State：用于根据路由器和其相邻路由的状态信息计算相应的链路代价，一般表示是费用、距离、时延、带宽等，计算的方法可以管理员自己设计</p>
</li>
<li>
<p>建立邻居关系：使用问候（hello）分组建立与维护邻居关系，问候分组发送的周期是10秒钟，40秒未收到邻居路由器的问候分组，则认为邻居路由器不可达</p>
</li>
<li>
<p>链路状态通告Link State Advertisement，LSA包含：</p>
<ul>
<li>
<p>直连网络的链路状态信息</p>
</li>
<li>
<p>邻居路由器的链路状态信息</p>
</li>
</ul>
</li>
<li>
<p>链路状态更新分组Link State Update，采用可靠的洪泛法，可靠是指收到更新分组后要发送确认，如果收到重复的更新分组只需要确认一次</p>
</li>
<li>
<p>链路状态数据库Link State Database，存储链路状态通告LSA，基于LSDB中的信息进行最短路径计算</p>
</li>
</ul>
<p>OSPF的五种分组类型：</p>
<ul>
<li>
<p>问候分组</p>
</li>
<li>
<p>数据库描述分组</p>
</li>
<li>
<p>链路状态请求分组</p>
</li>
<li>
<p>链路状态更新分组</p>
</li>
<li>
<p>链路状态确认分组</p>
</li>
</ul>
<p>OSPF基本工作流程：  <img src="https://cdn.jsdelivr.net/gh/hyattdd/cloud_img@master/blog/image%207-7902035.png" alt="image 7"></p>
<p>问题：洪泛问候、更新的话，感觉次数太多很浪费时间，怎么解决？</p>
<p>解决办法：</p>
<p><strong>采取指定的路由器方法</strong></p>
<ul>
<li>
<p>选举指定的路由器（DR）和备用的指定路由器（BDR）</p>
</li>
<li>
<p>所有的非DR/BDR只和DR/BDR建立邻居关系</p>
</li>
<li>
<p>非DR/BDR之间借助DR/BDR传递信息</p>
</li>
</ul>
<p><strong>将自治域划分为更小的区域</strong></p>
<ul>
<li>
<p>把一个自治系统AS划分为更小的<strong>区域（area）</strong>，每个区域路由器一般不超过200个</p>
</li>
<li>
<p>使得洪泛的范围局限于每一个区域，减少了整个网络上的通信量</p>
</li>
</ul>
<h2 id="4-边界网关协议">4. 边界网关协议</h2>
<p>边界网关协议（Border Gateway Protocol，BGP）属于外部网关协议EGP这个类别，用于自治系统AS之间的路由选择协议。BGP只能是力求寻找到一条能够到达目的网络且比较好的路由（不能兜圈子），而并非要寻找一条最佳路由。BGP采用了**路径向量（Path Vector）**路由选择协议。</p>
<ul>
<li>
<p>在配置BGP时，每个AS的管理员要选择至少一个路由器作为该AS的“BGP发言人”。一般来说，两个BGP发言人都是通过一个共享网络连接在一起的，而BGP发言人往往就是BGP边界路由器。</p>
</li>
<li>
<p>使用TCP连接（端口号为179）交换路由信息的两个BGP发言人，彼此称为对方的邻站（neighbor）或对等站（peer）。<strong>BGP发言人除了运行BGP协议外，还必须运行自己所在AS所使用的内部网关协议IGP</strong>，例如RIP或OSPF。</p>
</li>
<li>
<p>BGP发言人交换网络可达性的信息，也就是要到达某个网络所要经过的一系列自治系统。当BGP发言人相互交换了网络可达性的信息后，各BGP发言人就根据所采用的策略，从收到的路由信息中找出到达各自治系统的较好的路由，也就是构造出树形结构且不存在环路的自治系统连通图。</p>
</li>
</ul>
<p>RFC 4271中规定的BGP-4的四种报文：</p>
<ul>
<li>
<p>OPEN（打开报文）</p>
</li>
<li>
<p>UPDATE （更新报文）</p>
</li>
<li>
<p>KEEPALIVE（保活报文）</p>
</li>
<li>
<p>NOTIFICATION（通知报文）</p>
</li>
</ul>
<h2 id="参考资料">参考资料</h2>
<ol>
<li>
<p>《计算机网络》第七版 - 谢希仁</p>
</li>
<li>
<p><a target="_blank" rel="noopener" href="https://kdocs.cn/l/ceLxGZ0br8Gy">https://kdocs.cn/l/ceLxGZ0br8Gy</a></p>
</li>
<li>
<p><a target="_blank" rel="noopener" href="https://www.kdocs.cn/view/l/cbQ4uBPBPb7g">https://www.kdocs.cn/view/l/cbQ4uBPBPb7g</a></p>
</li>
</ol>
</article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/IP/">IP</a><a class="post-meta__tags" href="/tags/protocol/">protocol</a></div><div class="post_share"><div class="social-share" data-image="/./img/touxiang.png" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/./img/touxiang.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Henry.D</div><div class="author-info__description">Seek truth from the facts.</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">40</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">47</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">11</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/HyattDD"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/HyattDD" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:tjudht@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E7%BD%91%E7%BB%9C%E5%B1%82%E6%A6%82%E8%BF%B0"><span class="toc-number">1.</span> <span class="toc-text">1. 网络层概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E7%BD%91%E7%BB%9C%E5%B1%82%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%86%85%E5%AE%B9"><span class="toc-number">1.1.</span> <span class="toc-text">1.1 网络层的工作内容</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E7%BD%91%E7%BB%9C%E5%B1%82%E7%BB%99%E8%BF%90%E8%BE%93%E5%B1%82%E6%8F%90%E4%BE%9B%E7%9A%84%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.2.</span> <span class="toc-text">1.2 网络层给运输层提供的服务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E7%BD%91%E9%99%85%E5%8D%8F%E8%AE%AE"><span class="toc-number">2.</span> <span class="toc-text">2.网际协议</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AEIP%E7%9A%84%E7%94%B1%E6%9D%A5"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 网络协议IP的由来</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-IPV4%E5%9C%B0%E5%9D%80"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 IPV4地址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E5%9C%B0%E5%9D%80%E8%A7%A3%E6%9E%90%E5%8D%8F%E8%AE%AEARP"><span class="toc-number">2.3.</span> <span class="toc-text">2.3 地址解析协议ARP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-IP%E6%95%B0%E6%8D%AE%E6%8A%A5%E7%9A%84%E4%BC%A0%E9%80%81%E4%B8%8E%E9%9D%99%E6%80%81%E8%B7%AF%E7%94%B1%E9%85%8D%E7%BD%AE"><span class="toc-number">2.4.</span> <span class="toc-text">2.4 IP数据报的传送与静态路由配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-IP%E6%95%B0%E6%8D%AE%E6%8A%A5%E6%A0%BC%E5%BC%8F"><span class="toc-number">2.5.</span> <span class="toc-text">2.5 IP数据报格式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-%E7%BD%91%E9%99%85%E6%8E%A7%E5%88%B6%E6%8A%A5%E6%96%87%E5%8D%8F%E8%AE%AEICMP"><span class="toc-number">2.6.</span> <span class="toc-text">2.6 网际控制报文协议ICMP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E5%86%85%E9%83%A8%E7%BD%91%E5%85%B3%E5%8D%8F%E8%AE%AE"><span class="toc-number">3.</span> <span class="toc-text">3. 内部网关协议</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E8%B7%AF%E7%94%B1%E9%80%89%E6%8B%A9%E5%88%86%E7%B1%BB"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 路由选择分类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E5%88%86%E5%B1%82%E8%B7%AF%E7%94%B1%E9%80%89%E6%8B%A9%E5%8D%8F%E8%AE%AE"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 分层路由选择协议</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-RIP-%E8%B7%AF%E7%94%B1%E4%BF%A1%E6%81%AF%E5%8D%8F%E8%AE%AE%EF%BC%88Routing-Information-Protocol%EF%BC%89"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 RIP 路由信息协议（Routing Information Protocol）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-OSPF-%E5%BC%80%E6%94%BE%E6%9C%80%E7%9F%AD%E8%B7%AF%E5%BE%84%E4%BC%98%E5%85%88-%EF%BC%88Open-Shortest-Path-First%EF%BC%89"><span class="toc-number">3.4.</span> <span class="toc-text">3.4 OSPF 开放最短路径优先 （Open Shortest Path First）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E8%BE%B9%E7%95%8C%E7%BD%91%E5%85%B3%E5%8D%8F%E8%AE%AE"><span class="toc-number">4.</span> <span class="toc-text">4. 边界网关协议</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-number">5.</span> <span class="toc-text">参考资料</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/07/18/Paper%20Reading%20Note-Gavel/" title="Paper Reading Note of OSDI2020 Paper - Gavel">Paper Reading Note of OSDI2020 Paper - Gavel</a><time datetime="2023-07-18T00:00:00.000Z" title="Created 2023-07-18 08:00:00">2023-07-18</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/07/11/Using%20CUDA%20on%20WSL2/" title="GPU Programming Basic Knowledge">GPU Programming Basic Knowledge</a><time datetime="2023-07-11T01:00:00.000Z" title="Created 2023-07-11 09:00:00">2023-07-11</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/07/06/Paper%20Reading%20Note-Pollux/" title="Paper Reading Note of OSDI2021 Best Paper - Pollux">Paper Reading Note of OSDI2021 Best Paper - Pollux</a><time datetime="2023-07-06T00:00:00.000Z" title="Created 2023-07-06 08:00:00">2023-07-06</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/06/23/Simple%20Guide%20of%20Bazel/" title="Simple Guide of Bazel">Simple Guide of Bazel</a><time datetime="2023-06-23T11:00:00.000Z" title="Created 2023-06-23 19:00:00">2023-06-23</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/04/23/Recsys/" title="Recommend System Based on Bipartite Graph">Recommend System Based on Bipartite Graph</a><time datetime="2023-04-23T11:00:00.000Z" title="Created 2023-04-23 19:00:00">2023-04-23</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By Henry.D</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex/dist/contrib/copy-tex.min.js"></script><script>(() => {
  document.querySelectorAll('#article-container span.katex-display').forEach(item => {
    btf.wrap(item, 'div', { class: 'katex-wrap'})
  })
})()</script><script>(() => {
  const $mermaidWrap = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaidWrap.length) {
    window.runMermaid = () => {
      window.loadMermaid = true
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

      Array.from($mermaidWrap).forEach((item, index) => {
        const mermaidSrc = item.firstElementChild
        const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
        const mermaidID = 'mermaid-' + index
        const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent
        mermaid.mermaidAPI.render(mermaidID, mermaidDefinition, (svgCode) => {
          mermaidSrc.insertAdjacentHTML('afterend', svgCode)
        })
      })
    }

    const loadMermaid = () => {
      window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
    }

    window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
  }
})()</script></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>